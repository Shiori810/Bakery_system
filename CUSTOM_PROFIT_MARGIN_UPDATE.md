# 商品ごとの利益率設定機能 - 更新ガイド

## 概要

このアップデートにより、商品（レシピ）ごとに個別の利益率を設定できるようになりました。

### 主な変更点

1. **商品ごとの利益率設定**
   - レシピごとに専用の利益率を設定可能
   - 未設定の場合は基本設定の利益率を使用（従来通り）

2. **柔軟な運用**
   - 基本設定の利益率: 店舗全体のデフォルト値
   - 商品設定の利益率: 特定商品の個別設定（オプション）

## 使用方法

### 1. 基本設定（従来通り）

設定画面で店舗全体の利益率を設定します（例: 30%）

### 2. 商品ごとの利益率設定（新機能）

レシピの作成・編集画面で「商品ごとの利益率(%)」フィールドに値を入力します。

- **入力した場合**: その商品専用の利益率が適用されます
- **空欄の場合**: 基本設定の利益率が適用されます

### 3. 表示の違い

#### レシピ詳細画面
- 利益率の横にバッジが表示されます
  - 「商品設定」: 商品ごとの利益率を使用
  - 「基本設定」: 店舗の基本利益率を使用

#### レシピ一覧画面
- 商品ごとの利益率を設定している商品には、推奨価格の横に利益率が表示されます

## データベース更新

### 新規インストールの場合
特別な操作は不要です。アプリケーションを起動すると自動的に正しいスキーマが作成されます。

### 既存データベースの更新

既存のデータベースに新しいカラムを追加する必要があります。

#### 方法1: マイグレーションスクリプトを使用

```bash
python migrate_add_custom_profit_margin.py
```

#### 方法2: 手動でSQLを実行

SQLiteの場合:
```sql
ALTER TABLE recipes ADD COLUMN custom_profit_margin NUMERIC(5, 2);
```

PostgreSQLの場合:
```sql
ALTER TABLE recipes ADD COLUMN custom_profit_margin NUMERIC(5, 2);
```

## 技術的な詳細

### データベーススキーマの変更

**recipesテーブル**
```python
custom_profit_margin = db.Column(db.Numeric(5, 2))  # 商品ごとの利益率(%)、Noneの場合は基本設定を使用
```

### 計算ロジック

```python
# 商品ごとの利益率があればそれを使用、なければ基本設定を使用
profit_margin = recipe.custom_profit_margin if recipe.custom_profit_margin is not None else cost_setting.profit_margin

# 販売推奨価格 = 単価 × (1 + 利益率/100)
suggested_price = unit_cost * (1 + profit_margin / 100)
```

### 変更されたファイル

1. **app/models.py**
   - `Recipe.custom_profit_margin`フィールドを追加
   - `calculate_suggested_price()`メソッドを修正
   - `get_profit_margin()`メソッドを追加

2. **app/forms.py**
   - `RecipeForm.custom_profit_margin`フィールドを追加

3. **app/templates/recipes/form.html**
   - 利益率入力フィールドを追加

4. **app/templates/recipes/detail.html**
   - 利益率のバッジ表示を追加

5. **app/templates/recipes/index.html**
   - 商品ごとの利益率バッジ表示を追加

## 使用例

### ケース1: 基本設定のみ使用
- 基本設定の利益率: 30%
- 食パンのcustom_profit_margin: 未設定（NULL）
- **結果**: 食パンは30%の利益率で計算される

### ケース2: 商品ごとに異なる利益率
- 基本設定の利益率: 30%
- 食パンのcustom_profit_margin: 30%（未設定）
- メロンパンのcustom_profit_margin: 50%
- クロワッサンのcustom_profit_margin: 40%

**結果**:
- 食パン: 30%（基本設定）
- メロンパン: 50%（商品設定）
- クロワッサン: 40%（商品設定）

### ケース3: 価格計算の例

商品: メロンパン
- 原価: 100円
- 商品ごとの利益率: 50%
- **販売推奨価格**: 100円 × (1 + 50/100) = 150円

## 注意事項

1. **既存のレシピ**: マイグレーション後、既存のレシピはすべて`custom_profit_margin = NULL`となり、基本設定の利益率を使用します。

2. **バリデーション**: 利益率は0〜100%の範囲で入力してください。

3. **小数点**: 利益率は小数点以下2桁まで対応しています（例: 33.33%）。

4. **後方互換性**: この変更は既存の動作を変更しません。商品ごとの利益率を設定しない限り、従来通り基本設定の利益率が使用されます。

## トラブルシューティング

### マイグレーションエラーが発生する場合

1. データベースファイルの場所を確認してください
   - デフォルト: `instance/bakery.db`
   - 環境変数: `DATABASE_URL`

2. データベースへの書き込み権限があることを確認してください

3. 手動でSQLを実行してください（方法2を参照）

### 利益率が反映されない場合

1. アプリケーションを再起動してください
2. マイグレーションが正常に完了したか確認してください
3. レシピを編集して利益率を保存し直してください

## サポート

問題が発生した場合は、以下の情報を確認してください:
- データベースの種類（SQLite / PostgreSQL）
- エラーメッセージの内容
- マイグレーションスクリプトの実行結果
