# カスタムドメイン設定に関する議論と調査

## 概要
このドキュメントは、Renderにデプロイした `https://bakery-system.onrender.com` を既存のカスタムドメイン `https://bakery.etsu-dev.com/` に設定する際の調査内容と、発生した問題の原因分析を記録したものです。

## 日付
2025年10月28日

## 背景

### 前提条件
- 前日（2025年10月27日）に新しいRenderプロジェクト `Bakery_system` を作成しデプロイ成功
- 公開URL: https://bakery-system.onrender.com
- 既存のカスタムドメイン `bakery.etsu-dev.com` が存在
- Shiori810さんと共同開発中

### 発生した問題
`https://bakery.etsu-dev.com/` にアクセスすると「Internal Server Error」が表示される

## 調査内容

### 1. 現在の状況確認

#### 動作状況
- ✓ `https://bakery-system.onrender.com` → 正常に動作
- ✗ `https://bakery.etsu-dev.com/` → Internal Server Error

#### Renderの構成
- **Web Service**: `Bakery_system`（1つのみ存在）
  - STATUS: Deployed
  - RUNTIME: Python 3
  - REGION: Oregon
  - 作成: 約20時間前（2025年10月27日）
  - URL: https://bakery-system.onrender.com

- **Database**: `bakery-db`
  - PostgreSQL（無料プラン）
  - REGION: Singapore

#### GitHubリポジトリ
- リポジトリ: `Shiori810/Bakery_system`
- 最新コミット: デプロイドキュメント追加（2025年10月27日）

### 2. 問題の原因分析

#### 根本的な原因
**新しいRenderプロジェクトを作成したため、URLが変わった**

**以前の状態:**
```
bakery.etsu-dev.com → [古いサーバー]
```

**現在の状態:**
```
bakery.etsu-dev.com → [古いサーバー]（Internal Server Error）
bakery-system.onrender.com → [新しいサーバー]（正常動作）
```

**お名前.comのDNS設定:**
- `bakery` サブドメインのCNAMEレコードが古いサーバーを向いている
- そのため `bakery.etsu-dev.com` はエラーになる

#### 古いサーバーの所在
調査の結果、以下のいずれかの可能性：

1. **別のRenderアカウント**にある
   - Shiori810さんのアカウント
   - または別の共同開発者のアカウント

2. **削除されたRenderプロジェクト**
   - 過去に削除されたが、DNS設定が残っている

3. **別のホスティングサービス**
   - Heroku、Vercel、AWS等

4. **Renderの別プロジェクト**（ただし、現在のアカウントには見つからない）

### 3. カスタムドメイン設定に関する理解

#### デプロイとDNS設定の関係

**ユーザーからの質問:**
> 「デプロイするたびにお名前ドットコムでの設定は基本的に不要と聞きました。なぜ今回のデプロイがお名前ドットコムにアクセスする必要があるのでしょうか？」

**回答:**
通常、DNS設定は初回のみ必要で、その後のデプロイでは不要です。

**DNS設定が必要な場合（初回のみ）:**
- 新しいドメインを設定する時
- 新しいホスティングサービスに移行する時
- 新しいプロジェクトを作成した時

**DNS設定が不要な場合（通常のデプロイ）:**
- 同じプロジェクトに対してコードを更新する時
- GitHubにプッシュして自動デプロイする時

**今回の状況:**
昨日、**新しいRenderプロジェクト** `Bakery_system` を作成したため、これは「初回設定」と同じ状況。そのため、DNS設定変更が必要。

### 4. Web Service作成のタイミング

#### ユーザーからの質問
> 「Web Serviceを作成するときに何かをまちがえたということでしょうか？Web Serviceは昨日どのタイミングで作成しましたか？」

#### 回答と分析

**昨日（2025年10月27日）の作業フロー:**

1. **ユーザー**: 「今日の作業をGitにプッシュしてデプロイしたい」
2. **Claude**: GitHubにプッシュ実行
3. **ユーザー**: Renderの画面を開く
4. **ユーザー**: 「New Web Service」から新しいプロジェクトを作成
5. **Claude**: 環境変数、Start Command等の設定をサポート
6. **結果**: デプロイ成功 → https://bakery-system.onrender.com

**Web Service作成に間違いはなかった:**
- 手順は正しい
- 設定も正しい
- デプロイも成功

**問題:**
既存の `bakery.etsu-dev.com` 用のプロジェクトが別の場所に存在していた可能性があり、新しいプロジェクトを作成したことで、2つのプロジェクトが存在する状態になった。

**本来取れた選択肢（もし事前に知っていれば）:**

##### 選択肢A: 既存プロジェクトを更新
- 既存の `bakery.etsu-dev.com` 用プロジェクトを探す
- そのプロジェクトに最新コードをデプロイ
- DNS設定変更不要

##### 選択肢B: 新規プロジェクト + DNS設定
- 新しいプロジェクト `Bakery_system` を作成（実際に行ったこと）
- Renderで有料プランにアップグレード
- お名前.comのDNS設定を新しいプロジェクトに向ける

**なぜ新規プロジェクトを作成したのか:**
以下のいずれかの理由が考えられる：

1. Renderダッシュボードに既存プロジェクトが表示されていなかった（別アカウント）
2. 既存プロジェクトの存在を知らなかった
3. クリーンな環境で始めたかった

### 5. ローカルクローンについて

#### ユーザーからの質問
> 「bakery.etsu-dev.com にデプロイするためには、ローカルにクローンする時点から何かが間違っていたのでしょうか？」

#### 回答
**いいえ、ローカルクローンは全く問題ありませんでした。**

**正しかった手順:**
1. ✓ GitHubリポジトリ `Shiori810/Bakery_system` をクローン
2. ✓ ローカル環境で機能追加・修正
3. ✓ GitHubにプッシュ
4. ✓ Renderでデプロイ

**問題ではなかったこと:**
- クローン方法
- 開発プロセス
- コード品質
- デプロイ手順

**実際の問題:**
既存のカスタムドメイン設定と新しいプロジェクトの接続が未完了。これはデプロイ後の設定作業であり、開発プロセスとは無関係。

## 解決方法

### 方法1: Shiori810さんに確認（推奨）

**確認事項:**
1. 「以前 `bakery.etsu-dev.com` にデプロイしていたRenderプロジェクトはどこにありますか？」
2. 「そのプロジェクトのRenderアカウントはどれですか？」
3. 「お名前.comのDNS設定にアクセスできますか？」

**もし古いプロジェクトが見つかった場合:**
- そのプロジェクトに最新コードをデプロイ
- DNS設定変更不要
- すぐに `bakery.etsu-dev.com` で公開可能

### 方法2: 新しいプロジェクトにカスタムドメインを設定

#### ステップ1: Renderで有料プランにアップグレード
**重要:** Renderの無料プランではカスタムドメイン利用不可

1. Renderダッシュボード → Bakery_system
2. 右上の「Upgrade」ボタンをクリック
3. **Starter プラン ($7/月)** を選択
4. 支払い情報を入力

#### ステップ2: Renderでカスタムドメインを追加
1. Bakery_system → **Settings**
2. 下にスクロールして **Custom Domain** セクション
3. **Add Custom Domain** をクリック
4. `bakery.etsu-dev.com` と入力
5. 表示されるCNAME値をメモ（通常は `bakery-system.onrender.com`）

#### ステップ3: お名前.comのDNS設定を変更
1. お名前.com Naviにログイン: https://www.onamae.com/navi/login/
2. 「ドメイン設定」→「DNS設定/転送設定」
3. `etsu-dev.com` を選択
4. `bakery` サブドメインのCNAMEレコードを編集：
   - **Type**: CNAME
   - **Host**: `bakery`
   - **Value**: `bakery-system.onrender.com`（Renderが指定した値）
   - **TTL**: 3600
5. 保存

#### ステップ4: DNS伝播を待つ
- 変更後、15分〜1時間程度でDNSが伝播
- `https://bakery.etsu-dev.com/` が新しいRenderサーバーに接続される
- Renderが自動的にSSL証明書を発行

#### ステップ5: 確認
```bash
# DNS伝播確認
nslookup bakery.etsu-dev.com

# ブラウザでアクセス
https://bakery.etsu-dev.com/
```

### 方法3: 現状維持（費用をかけない）

**このまま `bakery-system.onrender.com` を使用**
- メリット: 無料プラン継続、DNS設定変更不要
- デメリット: URLが長い、`.onrender.com` ドメイン

## コスト比較

### 無料プランのまま
- **月額**: $0
- **URL**: https://bakery-system.onrender.com
- **制限**:
  - 15分間アクセスなしでスリープ
  - カスタムドメイン不可

### 有料プランにアップグレード
- **月額**: $7
- **URL**: https://bakery.etsu-dev.com（カスタムドメイン）
- **メリット**:
  - スリープなし
  - カスタムドメイン対応
  - 自動SSL証明書

## 共同開発における推奨事項

### 1. プロジェクトの所有者を明確にする
- Renderアカウントの所有者
- ドメイン管理者（お名前.com）
- GitHubリポジトリの管理者

### 2. デプロイ前の確認
- 既存のデプロイ環境を確認
- カスタムドメインの有無を確認
- DNS設定の現状を確認

### 3. ドキュメント化
- デプロイ先のURL
- Renderアカウント情報（所有者）
- DNS設定情報
- 環境変数一覧

### 4. コミュニケーション
- デプロイ作業前に共同開発者に確認
- 既存環境の変更について合意
- カスタムドメイン使用の有無を決定

## 次のステップ

### 推奨される行動
1. **Shiori810さんに確認**
   - 既存の `bakery.etsu-dev.com` のデプロイ先
   - お名前.comへのアクセス権限
   - 今後の方針（カスタムドメイン使用の有無）

2. **方針決定**
   - 無料プランで `bakery-system.onrender.com` を使う
   - 有料プラン（$7/月）で `bakery.etsu-dev.com` を使う
   - 既存プロジェクトに統合する

3. **実行**
   - 決定した方針に基づいて設定作業を実施

## まとめ

### 問題の本質
- **技術的な間違いはなかった**
- 新しいプロジェクト作成 vs 既存プロジェクト更新の選択の問題
- カスタムドメインと新規プロジェクトの接続が未完了

### 学んだこと
1. **デプロイの種類**
   - 既存プロジェクトへの更新 → DNS設定変更不要
   - 新規プロジェクト作成 → DNS設定が必要（初回設定と同じ）

2. **カスタムドメインの要件**
   - Renderで有料プラン必要（$7/月〜）
   - DNS設定変更が必要（初回のみ）
   - SSL証明書は自動発行

3. **共同開発の注意点**
   - 既存環境の確認が重要
   - 事前のコミュニケーションが必要
   - ドキュメント化が重要

### 現在の状態
- ✓ 新しいRenderプロジェクト `Bakery_system` が正常稼働
- ✓ https://bakery-system.onrender.com でアクセス可能
- ✓ すべての新機能が実装済み
- ⚠ カスタムドメイン `bakery.etsu-dev.com` が未接続
- ⚠ 古いサーバーの所在が不明

### 今後の選択肢
1. Shiori810さんに確認して既存プロジェクトを探す（推奨）
2. 有料プランにして新プロジェクトにカスタムドメインを設定
3. 無料プランのまま `.onrender.com` ドメインを使用

---
作成日: 2025年10月28日
関連ドキュメント:
- [Renderデプロイガイド](RENDER_DEPLOYMENT_GUIDE.md)
- [デプロイ手順](DEPLOY.md)
