# 人件費・光熱費のカスタム原価項目化 機能説明書

## 概要

**バージョン**: v1.5.0
**実装日**: 2025-10-29
**機能名**: 人件費・光熱費のカスタム原価項目化

人件費と光熱費の管理を、専用フィールドからカスタム原価項目管理システムへ統合しました。これにより、すべての原価項目を一つの統一的なシステムで管理できるようになりました。

---

## 主な変更点

### 1. データモデルの変更

#### CostSettingテーブル (簡素化)

**削除されたフィールド**:
- `include_labor_cost` - 人件費を含めるかのフラグ
- `include_utility_cost` - 光熱費を含めるかのフラグ
- `hourly_wage` - 時給
- `monthly_utility_cost` - 月額光熱費

**残ったフィールド**:
- `id` - プライマリキー
- `store_id` - 店舗ID
- `profit_margin` - 利益率(%)
- `created_at` - 作成日時
- `updated_at` - 更新日時

#### CustomCostItemテーブル (活用拡大)

人件費と光熱費もこのテーブルで管理するようになりました:

```python
class CustomCostItem(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    store_id = db.Column(db.Integer, nullable=False)
    name = db.Column(db.String(100), nullable=False)  # 例: "人件費", "光熱費"
    calculation_type = db.Column(db.String(20))  # "per_time" (時間あたり)
    amount = db.Column(db.Numeric(10, 2))  # 分単価
    is_active = db.Column(db.Boolean, default=True)  # 有効/無効
    description = db.Column(db.String(255))  # 説明
    display_order = db.Column(db.Integer, default=0)
```

---

### 2. 計算ロジックの変更

#### 変更前 (Recipe.calculate_total_cost)

```python
# 材料費
material_cost = self.calculate_material_cost()
total_cost = material_cost

# 人件費の計算
if cost_setting.include_labor_cost and self.production_time > 0:
    labor_cost = hourly_wage * (production_time / 60)
    total_cost += labor_cost

# 光熱費の計算
if cost_setting.include_utility_cost and self.production_time > 0:
    utility_cost = (monthly_utility_cost / 30 / 24) * (production_time / 60)
    total_cost += utility_cost

# カスタム原価項目の計算
for item in custom_items:
    total_cost += item.calculate_cost(self)
```

#### 変更後 (シンプル化)

```python
# 材料費
material_cost = self.calculate_material_cost()
total_cost = material_cost

# カスタム原価項目の計算（人件費・光熱費を含むすべて）
for item in custom_items:
    total_cost += item.calculate_cost(self)
```

---

### 3. 計算式の変換

#### 人件費

**旧方式**:
```
人件費 = 時給(円/時) × (製造時間(分) / 60)
```

**新方式**:
```
人件費 = 分単価(円/分) × 製造時間(分)
```

**変換式**:
```
分単価 = 時給 ÷ 60
```

**例**: 時給1,200円、製造時間180分の場合
- 旧: `1200 × (180 / 60) = 1200 × 3 = 3,600円`
- 新: `(1200 / 60) × 180 = 20 × 180 = 3,600円` ✓

#### 光熱費

**旧方式**:
```
光熱費 = (月額光熱費 / 30日 / 24時間) × (製造時間(分) / 60)
```

**新方式**:
```
光熱費 = 分単価(円/分) × 製造時間(分)
```

**変換式**:
```
分単価 = 月額光熱費 ÷ 30 ÷ 24 ÷ 60 = 月額光熱費 ÷ 43200
```

**例**: 月額30,000円、製造時間180分の場合
- 旧: `(30000 / 30 / 24) × (180 / 60) = 41.67 × 3 = 125円`
- 新: `(30000 / 43200) × 180 = 0.6944 × 180 = 125円` ✓

---

### 4. UI/UXの変更

#### 設定画面 ([app/templates/main/settings.html](app/templates/main/settings.html))

**変更前**:
- 人件費チェックボックス
- 光熱費チェックボックス
- 時給入力フィールド
- 月額光熱費入力フィールド
- 利益率入力フィールド
- カスタム原価項目へのリンク

**変更後**:
- 原価項目管理への案内(目立つ)
- 利益率入力フィールドのみ
- シンプルで分かりやすいレイアウト

**スクリーンショット**:
```
┌─────────────────────────────────────────┐
│ 原価計算設定                              │
├─────────────────────────────────────────┤
│ ┌──────────────────────────────────┐    │
│ │ ℹ️ 原価項目の管理                 │    │
│ │                                  │    │
│ │ 人件費、光熱費、包装費など、       │    │
│ │ すべての原価項目はカスタム原価     │    │
│ │ 項目管理で設定します。            │    │
│ │                                  │    │
│ │ [カスタム原価項目管理を開く]      │    │
│ └──────────────────────────────────┘    │
│                                         │
│ ┌──────────────────────────────────┐    │
│ │ 利益率設定                        │    │
│ │                                  │    │
│ │ 利益率(%): [____30___] %         │    │
│ │                                  │    │
│ │ [← 戻る]           [保存]       │    │
│ └──────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

#### カスタム原価項目管理画面 ([app/templates/custom_costs/index.html](app/templates/custom_costs/index.html))

**追加された機能**:

1. **分単価変換ツール** (新機能)
   - 時給から分単価への自動変換
   - 月額光熱費から分単価への自動変換
   - リアルタイム計算

2. **改善された説明文**
   - 人件費・光熱費の例を追加
   - 換算例の表示
   - より詳しいヒント

**スクリーンショット**:
```
┌─────────────────────────────────────────────────────────┐
│ カスタム原価項目管理                                       │
├─────────────────────────────────────────────────────────┤
│ ℹ️ カスタム原価項目とは？                                 │
│ 材料費以外のすべての原価項目を自由に設定できます。         │
│ 例: 人件費、光熱費、包装費、減価償却費など                │
├─────────────────────────────────────────────────────────┤
│ 🧮 分単価変換ツール                                       │
│ ┌─────────────────────┬─────────────────────┐          │
│ │ 👤 時給 → 分単価      │ ⚡ 月額光熱費 → 分単価 │          │
│ │                     │                     │          │
│ │ 時給: [_1200_] 円    │ 月額: [30000_] 円   │          │
│ │                     │                     │          │
│ │ 分単価: 20.00 円/分  │ 分単価: 0.6944 円/分 │          │
│ └─────────────────────┴─────────────────────┘          │
├─────────────────────────────────────────────────────────┤
│ ➕ 新しい原価項目を追加                                   │
│ [項目名] [計算方法▼] [金額] [説明] [追加]                │
├─────────────────────────────────────────────────────────┤
│ 📋 登録済み原価項目                                       │
│ ┌───┬────────┬──────────┬─────────┬────────┐         │
│ │ ✓ │ 人件費  │ 時間あたり │ 20.00円/分│ [編集] │         │
│ │ ✓ │ 光熱費  │ 時間あたり │ 0.69円/分 │ [編集] │         │
│ │ ✓ │ 包装費  │ 個数あたり │ 10.00円/個│ [編集] │         │
│ └───┴────────┴──────────┴─────────┴────────┘         │
└─────────────────────────────────────────────────────────┘
```

---

## マイグレーション手順

### データベース移行スクリプト

**ファイル名**: [migrate_labor_utility_to_custom_costs.py](migrate_labor_utility_to_custom_costs.py)

**実行内容**:
1. 全店舗のCostSettingから人件費・光熱費設定を読み取り
2. CustomCostItemレコードを作成
   - 人件費: 時給を分単価に変換
   - 光熱費: 月額を分単価に変換
   - 有効/無効フラグを引き継ぎ
3. CostSettingテーブルから旧フィールドを削除

**実行方法**:

```bash
# ローカル環境（SQLite）
python migrate_labor_utility_to_custom_costs.py

# 本番環境（Render + PostgreSQL）
# Renderシェルで実行
python migrate_labor_utility_to_custom_costs.py
```

**安全機能**:
- 冪等性: 複数回実行しても問題なし
- 存在チェック: 既に「人件費」「光熱費」が存在する場合はスキップ
- 確認プロンプト: 実行前に確認を求める
- エラーハンドリング: 問題発生時は詳細なエラーメッセージ

**出力例**:
```
======================================================================
データベースマイグレーション: 人件費・光熱費のCustomCostItem化
======================================================================
データベース接続: sqlite:///...

ステップ1: 既存の人件費・光熱費設定を読み取り中...

[OK] 3店舗の設定を取得しました

ステップ2: CustomCostItemレコードを作成中...

  [作成] 店舗ID 1: 人件費 20.00円/分 (有効)
  [作成] 店舗ID 1: 光熱費 0.6944円/分 (有効)
  [作成] 店舗ID 2: 人件費 25.00円/分 (有効)
  [SKIP] 店舗ID 3: 「人件費」は既に存在します

[OK] CustomCostItem作成完了:
  - 人件費: 2件
  - 光熱費: 1件
  - スキップ: 1件

ステップ3: CostSettingテーブルから旧フィールドを削除中...

  [削除] include_labor_cost
  [削除] include_utility_cost
  [削除] hourly_wage
  [削除] monthly_utility_cost
  [OK] PostgreSQL: カラム削除完了

======================================================================
[OK] マイグレーションが正常に完了しました！
======================================================================

変更内容:
  1. 2件の人件費をCustomCostItemに移行
  2. 1件の光熱費をCustomCostItemに移行
  3. CostSettingテーブルから4つのカラムを削除

次のステップ:
  - アプリケーションを再起動
  - 設定画面で利益率設定を確認
  - カスタム原価項目管理で人件費・光熱費を確認
  - レシピ詳細画面で原価計算が正しいか確認
```

---

## 使い方

### 1. 人件費の設定

#### 時給から分単価を計算

**方法1: 変換ツールを使用** (推奨)

1. [カスタム原価項目管理](../custom-costs/)を開く
2. 「分単価変換ツール」に時給を入力 (例: 1200円)
3. 自動計算された分単価を確認 (例: 20.00円/分)
4. 「新しい原価項目を追加」フォームに以下を入力:
   - 項目名: `人件費`
   - 計算方法: `時間あたり（分単位）`
   - 金額: `20.00` (変換ツールで計算された値)
   - 説明: `時給1,200円` (任意)
5. [追加]ボタンをクリック

**方法2: 手動計算**

1. 時給を60で割る
   - 例: 時給1,200円 ÷ 60 = 20円/分
2. カスタム原価項目として登録

#### 例

| 時給(円/時) | 分単価(円/分) | 計算式 |
|-----------|-------------|--------|
| 1,000 | 16.67 | 1000 ÷ 60 |
| 1,200 | 20.00 | 1200 ÷ 60 |
| 1,500 | 25.00 | 1500 ÷ 60 |
| 1,800 | 30.00 | 1800 ÷ 60 |
| 2,000 | 33.33 | 2000 ÷ 60 |

### 2. 光熱費の設定

#### 月額から分単価を計算

**方法1: 変換ツールを使用** (推奨)

1. [カスタム原価項目管理](../custom-costs/)を開く
2. 「分単価変換ツール」に月額光熱費を入力 (例: 30000円)
3. 自動計算された分単価を確認 (例: 0.6944円/分)
4. 「新しい原価項目を追加」フォームに以下を入力:
   - 項目名: `光熱費`
   - 計算方法: `時間あたり（分単位）`
   - 金額: `0.6944` (変換ツールで計算された値)
   - 説明: `月額30,000円` (任意)
5. [追加]ボタンをクリック

**方法2: 手動計算**

1. 月額を43,200で割る (30日 × 24時間 × 60分)
   - 例: 月額30,000円 ÷ 43,200 = 0.6944円/分
2. カスタム原価項目として登録

#### 例

| 月額(円/月) | 分単価(円/分) | 計算式 |
|-----------|-------------|--------|
| 20,000 | 0.4630 | 20000 ÷ 43200 |
| 30,000 | 0.6944 | 30000 ÷ 43200 |
| 40,000 | 0.9259 | 40000 ÷ 43200 |
| 50,000 | 1.1574 | 50000 ÷ 43200 |
| 60,000 | 1.3889 | 60000 ÷ 43200 |

### 3. 原価計算の確認

#### レシピ詳細画面での確認

**例**: 食パンのレシピ
- 材料費: 200円
- 製造時間: 180分
- 製造個数: 10個
- 人件費設定: 20円/分 (有効)
- 光熱費設定: 0.69円/分 (有効)

**計算結果**:
```
材料費: 200円
人件費: 20円/分 × 180分 = 3,600円
光熱費: 0.69円/分 × 180分 = 124円
────────────────────────────
総原価: 3,924円
個数: 10個
1個あたり原価: 392.4円
```

---

## メリット

### 1. 統一的な管理

すべての原価項目を一つのシステムで管理できるようになりました。

**以前**:
- 人件費・光熱費: 設定画面
- その他原価: カスタム原価項目管理

**現在**:
- すべての原価: カスタム原価項目管理

### 2. 柔軟性の向上

人件費・光熱費も他の原価項目と同様に、以下が可能になりました:
- 有効/無効の切り替え
- 表示順序の変更
- 詳細な説明の追加
- 複数の人件費項目の登録 (例: パート、正社員)

### 3. コードの簡素化

特殊な計算ロジックが削減され、保守性が向上しました。

**削減された行数**:
- CostSettingモデル: 4フィールド削除
- CostSettingForm: 4フィールド削除
- Recipe.calculate_total_cost: 約15行削除
- settings.htmlテンプレート: 約50行削減

### 4. UI/UXの改善

- より直感的な画面レイアウト
- 便利な変換ツールの提供
- 詳しいヘルプと例の表示

---

## 互換性

### 後方互換性

マイグレーションスクリプトにより、既存のデータは自動的に新しいシステムに変換されます:

1. **データ保持**: 既存の人件費・光熱費設定は失われません
2. **計算結果**: マイグレーション前後で原価計算結果は同じです
3. **有効/無効**: フラグの状態も引き継がれます

### 注意事項

- マイグレーション後は元に戻せません（ロールバック手順は別途提供）
- 実行前に必ずバックアップを取ってください

---

## トラブルシューティング

### Q1: マイグレーション後、原価が変わってしまった

**原因**: マイグレーションスクリプトの変換ミス、または CustomCostItem が無効になっている

**確認方法**:
1. カスタム原価項目管理を開く
2. 人件費・光熱費の状態を確認
3. 有効/無効ボタンで切り替え

**確認すべき値**:
```
時給1,200円の場合:
  → 分単価は 20.00円/分 であるべき

月額30,000円の場合:
  → 分単価は 0.6944円/分 であるべき
```

### Q2: 「人件費」項目が2つできてしまった

**原因**: マイグレーション実行前に手動で「人件費」を作成していた

**解決方法**:
1. カスタム原価項目管理を開く
2. 重複している項目の一方を削除
3. 正しい方（マイグレーションで作成された方）を残す

### Q3: 変換ツールで計算した値と実際の原価が合わない

**確認事項**:
1. CustomCostItemの金額が正しく入力されているか
2. 項目が「有効」になっているか
3. 計算方法が「時間あたり」になっているか
4. レシピの製造時間が正しく設定されているか

### Q4: 設定画面から人件費・光熱費が消えた

**これは正常な動作です**。

人件費・光熱費は「カスタム原価項目管理」で設定するようになりました。

**移動先**:
設定画面 → [カスタム原価項目管理を開く] → カスタム原価項目管理

---

## 技術詳細

### データベーススキーマ

#### CostSetting (変更後)

```sql
CREATE TABLE cost_settings (
    id SERIAL PRIMARY KEY,
    store_id INTEGER NOT NULL UNIQUE,
    profit_margin NUMERIC(5, 2) DEFAULT 30.0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (store_id) REFERENCES stores(id)
);
```

#### CustomCostItem (活用拡大)

```sql
CREATE TABLE custom_cost_items (
    id SERIAL PRIMARY KEY,
    store_id INTEGER NOT NULL,
    name VARCHAR(100) NOT NULL,
    calculation_type VARCHAR(20) NOT NULL,  -- 'fixed', 'per_unit', 'per_time'
    amount NUMERIC(10, 2) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    description VARCHAR(255),
    display_order INTEGER DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (store_id) REFERENCES stores(id)
);
```

### 計算アルゴリズム

```python
def calculate_total_cost(self, cost_setting=None):
    """総原価の計算"""
    # 材料費
    total_cost = self.calculate_material_cost()

    # カスタム原価項目（人件費・光熱費を含む）
    custom_items = CustomCostItem.query.filter_by(
        store_id=self.store_id,
        is_active=True
    ).all()

    for item in custom_items:
        if item.calculation_type == 'per_time':
            # 時間あたり: amount(円/分) × production_time(分)
            cost = item.amount * self.production_time
        elif item.calculation_type == 'per_unit':
            # 個数あたり: amount(円/個) × production_quantity(個)
            cost = item.amount * self.production_quantity
        elif item.calculation_type == 'fixed':
            # 固定費: amount(円)
            cost = item.amount

        total_cost += cost

    return total_cost
```

---

## 関連ファイル

### モデル
- [app/models.py](app/models.py) - CostSetting, Recipe, CustomCostItem

### フォーム
- [app/forms.py](app/forms.py) - CostSettingForm

### ルート
- [app/routes/main.py](app/routes/main.py) - 設定画面
- [app/routes/custom_costs.py](app/routes/custom_costs.py) - カスタム原価項目管理

### テンプレート
- [app/templates/main/settings.html](app/templates/main/settings.html) - 設定画面
- [app/templates/custom_costs/index.html](app/templates/custom_costs/index.html) - カスタム原価項目管理画面

### マイグレーション
- [migrate_labor_utility_to_custom_costs.py](migrate_labor_utility_to_custom_costs.py) - マイグレーションスクリプト

### ドキュメント
- [LABOR_UTILITY_TO_CUSTOM_COSTS_PLAN.md](LABOR_UTILITY_TO_CUSTOM_COSTS_PLAN.md) - 実装計画書
- [LABOR_UTILITY_CUSTOM_COSTS_FEATURE.md](LABOR_UTILITY_CUSTOM_COSTS_FEATURE.md) - この機能説明書

---

## バージョン履歴

### v1.5.0 (2025-10-29)
- 人件費・光熱費をCustomCostItem管理に統合
- 分単価変換ツールを追加
- 設定画面のUIを簡素化
- カスタム原価項目管理のヘルプを強化

### v1.4.0 (2025-10-28)
- 商品ごとの利益率設定機能を追加
- パスワードリセット機能を追加
- ログインID復旧機能を追加

### v1.3.0 (2025-10-27)
- ラベルサイズカスタマイズ機能を追加
- 販売価格の手動設定機能を追加

### v1.2.0 (2025-10-27)
- 原価計算の単位変換対応

### v1.1.0 (2025-10-21)
- CustomCostItem機能の導入

---

## まとめ

人件費・光熱費のカスタム原価項目化により、パン屋向け原価計算アプリケーションは、より統一的で柔軟な原価管理システムを持つようになりました。

**主な改善点**:
1. ✅ すべての原価項目を一つのシステムで管理
2. ✅ より柔軟な原価設定が可能
3. ✅ コードの簡素化と保守性向上
4. ✅ UI/UXの改善（変換ツールの提供）
5. ✅ 既存データの自動移行

**ユーザーへの影響**:
- 原価計算結果は変わりません
- 設定方法が変更されますが、変換ツールでサポート
- より直感的で使いやすくなります

---

**作成日**: 2025-10-29
**作成者**: Claude Code (AI Assistant)
**バージョン**: 1.0
